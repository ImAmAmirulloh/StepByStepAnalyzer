<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Memory Pattern Recorder V3</title>

<style>
:root { --primary:#00bcd4; --bg:#f5f6fa; --text:#2f3640; }
body{
  font-family:Segoe UI,sans-serif;
  background:var(--bg);
  margin:0;
  padding:10px;
  display:flex;
  justify-content:center;
}
.main-container{
  background:#fff;
  padding:20px;
  border-radius:12px;
  max-width:600px;
  width:100%;
  box-shadow:0 4px 20px rgba(0,0,0,.1);
}
.preview-wrapper{
  position:relative;
  background:#000;
  border-radius:8px;
  overflow:hidden;
}
#videoPlayer{ width:100%; display:block; }
#overlayCanvas{
  position:absolute;
  top:0; left:0;
  pointer-events:none;
}
.slider-row{ margin:12px 0; }
.slider-header{
  display:flex;
  justify-content:space-between;
  font-size:.8rem;
  font-weight:bold;
}
.val-badge{
  background:#eee;
  padding:2px 6px;
  border-radius:4px;
  font-family:monospace;
}
input[type=range],input[type=number]{
  width:100%;
  accent-color:var(--primary);
}
.btn{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:6px;
  background:var(--primary);
  color:#fff;
  font-weight:bold;
  cursor: pointer;
}
.btn:disabled{ background:#bbb; cursor: not-allowed; }
#btnDownload{ display:none; background:#2ecc71; }
#status{ text-align:center; margin-top:10px; font-size:.9rem; }
</style>

<script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady()"></script>

<script>
let cvReady=false;
function onOpenCvReady(){
  cvReady=true;
  document.getElementById("status").innerText="OpenCV ready. Load video.";
}
</script>
</head>

<body>
<div class="main-container">

<input type="file" id="videoInput" accept="video/*">

<div class="preview-wrapper">
  <video id="videoPlayer" muted playsinline></video>
  <canvas id="overlayCanvas"></canvas>
</div>

<div class="slider-row">
  <div class="slider-header"><span>TOP</span><span id="v-t" class="val-badge">23%</span></div>
  <input type="range" id="marginTop" min="0" max="100" step="0.1" value="23">
</div>
<div class="slider-row">
  <div class="slider-header"><span>BOTTOM</span><span id="v-b" class="val-badge">15%</span></div>
  <input type="range" id="marginBottom" min="0" max="100" step="0.1" value="15">
</div>
<div class="slider-row">
  <div class="slider-header"><span>SIDE</span><span id="v-s" class="val-badge">5%</span></div>
  <input type="range" id="marginSide" min="0" max="50" step="0.1" value="5">
</div>

<div class="slider-row">
  <div class="slider-header"><span>START TIME</span><span id="v-start" class="val-badge">0.0s</span></div>
  <input type="range" id="startTime" step="0.1" value="0">
</div>
<div class="slider-row">
  <div class="slider-header"><span>END TIME</span><span id="v-end" class="val-badge">0.0s</span></div>
  <input type="range" id="endTime" step="0.1" value="0">
</div>

<button id="processBtn" class="btn" disabled>â–¶ START SCANNING</button>
<button id="btnDownload" class="btn">ðŸ’¾ DOWNLOAD JSON</button>

<div id="status">Waiting for OpenCVâ€¦</div>
</div>

<canvas id="procCanvas" style="display:none;"></canvas>

<script>
// Define elements explicitly to prevent ReferenceErrors
const video = document.getElementById('videoPlayer');
const overlay = document.getElementById('overlayCanvas');
const ctx = overlay.getContext("2d");
const inputVideo = document.getElementById('videoInput');
const btnProcess = document.getElementById('processBtn');
const btnDownload = document.getElementById('btnDownload');
const statusText = document.getElementById('status');

// Sliders
const sTop = document.getElementById('marginTop');
const sBot = document.getElementById('marginBottom');
const sSide = document.getElementById('marginSide');
const sStart = document.getElementById('startTime');
const sEnd = document.getElementById('endTime');

function drawOverlay(){
  if(!overlay.width) return;
  ctx.clearRect(0,0,overlay.width,overlay.height);

  const w = overlay.width;
  const h = overlay.height;
  
  // Use .value from the specific elements
  const t = sTop.value/100;
  const b = sBot.value/100;
  const s = sSide.value/100;

  const sx=w*s, ex=w*(1-s);
  const sy=h*t, ey=h*(1-b);
  const gw=ex-sx, gh=ey-sy;

  const cols=4, rows=5;
  const cw=gw/cols, ch=gh/rows;

  ctx.strokeStyle="#00bcd4"; ctx.lineWidth=2;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      ctx.strokeRect(sx+c*cw,sy+r*ch,cw,ch);
    }
  }
}

// Margin Slider Listeners
[sTop, sBot, sSide].forEach(el => {
  el.oninput = () => {
    // Determine which badge to update
    let badgeId = "";
    if(el.id === "marginTop") badgeId = "v-t";
    else if(el.id === "marginBottom") badgeId = "v-b";
    else if(el.id === "marginSide") badgeId = "v-s";
    
    // Update badge text
    document.getElementById(badgeId).innerText = parseFloat(el.value).toFixed(1) + "%";
    drawOverlay();
  };
});

// Video Input Listener
inputVideo.onchange = e => {
  if(!cvReady) return alert("Please wait for OpenCV to load.");
  if(!e.target.files[0]) return;

  video.src = URL.createObjectURL(e.target.files[0]);
  video.onloadedmetadata = () => {
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    drawOverlay();

    // Setup Time Sliders
    sStart.min = 0;
    sEnd.min = 0;
    sStart.max = video.duration;
    sEnd.max = video.duration;
    sEnd.value = video.duration;
    
    // Fix: Use getElementById for IDs with hyphens
    document.getElementById("v-end").innerText = video.duration.toFixed(1) + "s";

    btnProcess.disabled = false;
    statusText.innerText = "Video ready.";
  };
};

// Time Slider Listeners
sStart.oninput = () => {
  if(parseFloat(sStart.value) > parseFloat(sEnd.value)){
    sStart.value = sEnd.value;
  }
  document.getElementById("v-start").innerText = parseFloat(sStart.value).toFixed(1) + "s";
  // Optional: Seek video to preview time
  video.currentTime = sStart.value;
};

sEnd.oninput = () => {
  if(parseFloat(sEnd.value) < parseFloat(sStart.value)){
    sEnd.value = sStart.value;
  }
  document.getElementById("v-end").innerText = parseFloat(sEnd.value).toFixed(1) + "s";
  // Optional: Seek video to preview time
  video.currentTime = sEnd.value;
};

// Process Button
btnProcess.onclick = () => {
  statusText.innerText = `Scanning range: ${sStart.value}s â†’ ${sEnd.value}s`;
  // Logic OpenCV detection akan masuk di sini nanti
  // Untuk sekarang, kita tampilkan tombol download
  btnDownload.style.display = "block";
};

// Download Button
btnDownload.onclick = () => {
  const data = {
    start: sStart.value,
    end: sEnd.value,
    margins: {
        top: sTop.value,
        bottom: sBot.value,
        side: sSide.value
    }
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "pattern.json";
  document.body.appendChild(a); // Required for Firefox
  a.click();
  document.body.removeChild(a);
};
</script>

</body>
</html>