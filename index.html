<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Memory Pattern Recorder V3</title>

<style>
:root { --primary:#00bcd4; --bg:#f5f6fa; --text:#2f3640; }
body{
  font-family:Segoe UI,sans-serif;
  background:var(--bg);
  margin:0;
  padding:10px;
  display:flex;
  justify-content:center;
}
.main-container{
  background:#fff;
  padding:20px;
  border-radius:12px;
  max-width:600px;
  width:100%;
  box-shadow:0 4px 20px rgba(0,0,0,.1);
}
.preview-wrapper{
  position:relative;
  background:#000;
  border-radius:8px;
  overflow:hidden;
}
#videoPlayer{ width:100%; display:block; }
#overlayCanvas{
  position:absolute;
  top:0; left:0;
  pointer-events:none;
}
.slider-row{ margin:12px 0; }
.slider-header{
  display:flex;
  justify-content:space-between;
  font-size:.8rem;
  font-weight:bold;
}
.val-badge{
  background:#eee;
  padding:2px 6px;
  border-radius:4px;
  font-family:monospace;
}
input[type=range],input[type=number]{
  width:100%;
  accent-color:var(--primary);
}
.btn{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:6px;
  background:var(--primary);
  color:#fff;
  font-weight:bold;
}
.btn:disabled{ background:#bbb; }
#btnDownload{ display:none; background:#2ecc71; }
#status{ text-align:center; margin-top:10px; font-size:.9rem; }
</style>

<script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady()"></script>

<script>
let cvReady=false;
/* ‚≠ê new line change */
function onOpenCvReady(){
  cvReady=true;
  document.getElementById("status").innerText="OpenCV ready. Load video.";
}
</script>
</head>

<body>
<div class="main-container">

<input type="file" id="videoInput" accept="video/*">

<div class="preview-wrapper">
  <video id="videoPlayer" muted playsinline></video>
  <canvas id="overlayCanvas"></canvas>
</div>

<!-- MARGIN SLIDERS -->
<div class="slider-row">
  <div class="slider-header"><span>TOP</span><span id="v-t" class="val-badge">23%</span></div>
  <input type="range" id="marginTop" min="0" max="100" step="0.1" value="23">
</div>
<div class="slider-row">
  <div class="slider-header"><span>BOTTOM</span><span id="v-b" class="val-badge">15%</span></div>
  <input type="range" id="marginBottom" min="0" max="100" step="0.1" value="15">
</div>
<div class="slider-row">
  <div class="slider-header"><span>SIDE</span><span id="v-s" class="val-badge">5%</span></div>
  <input type="range" id="marginSide" min="0" max="50" step="0.1" value="5">
</div>

<!-- TIME RANGE SLIDERS -->
<div class="slider-row">
  <div class="slider-header"><span>START TIME</span><span id="v-start" class="val-badge">0.0s</span></div>
  <input type="range" id="startTime" step="0.1" value="0">
</div>
<div class="slider-row">
  <div class="slider-header"><span>END TIME</span><span id="v-end" class="val-badge">0.0s</span></div>
  <input type="range" id="endTime" step="0.1" value="0">
</div>

<button id="processBtn" class="btn" disabled>‚ñ∂ START SCANNING</button>
<button id="btnDownload" class="btn">üíæ DOWNLOAD JSON</button>

<div id="status">Waiting for OpenCV‚Ä¶</div>
</div>

<canvas id="procCanvas" style="display:none;"></canvas>

<script>
const video=videoPlayer;
const overlay=overlayCanvas;
const ctx=overlay.getContext("2d");

function drawOverlay(){
  if(!overlay.width) return;
  ctx.clearRect(0,0,overlay.width,overlay.height);

  const w=overlay.width,h=overlay.height;
  const t=marginTop.value/100;
  const b=marginBottom.value/100;
  const s=marginSide.value/100;

  const sx=w*s, ex=w*(1-s);
  const sy=h*t, ey=h*(1-b);
  const gw=ex-sx, gh=ey-sy;

  const cols=4,rows=5;
  const cw=gw/cols,ch=gh/rows;

  ctx.strokeStyle="#00bcd4"; ctx.lineWidth=2;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      ctx.strokeRect(sx+c*cw,sy+r*ch,cw,ch);
    }
  }
}

/* ‚≠ê new line change ‚Äî slider listeners */
["marginTop","marginBottom","marginSide"].forEach(id=>{
  const el=document.getElementById(id);
  el.oninput=()=>{
    document.getElementById(
      id==="marginTop"?"v-t":id==="marginBottom"?"v-b":"v-s"
    ).innerText=parseFloat(el.value).toFixed(1)+"%";
    drawOverlay();
  };
});

videoInput.onchange=e=>{
  if(!cvReady) return;
  video.src=URL.createObjectURL(e.target.files[0]);
  video.onloadedmetadata=()=>{
    overlay.width=video.videoWidth;
    overlay.height=video.videoHeight;
    drawOverlay();

    /* ‚≠ê new line change ‚Äî time slider setup */
    startTime.min=0;
    endTime.min=0;
    startTime.max=video.duration;
    endTime.max=video.duration;
    endTime.value=video.duration;
    v-end.innerText=video.duration.toFixed(1)+"s";

    processBtn.disabled=false;
    status.innerText="Video ready.";
  };
};

/* ‚≠ê new line change ‚Äî time slider sync */
startTime.oninput=()=>{
  if(parseFloat(startTime.value)>parseFloat(endTime.value)){
    startTime.value=endTime.value;
  }
  v-start.innerText=parseFloat(startTime.value).toFixed(1)+"s";
};
endTime.oninput=()=>{
  if(parseFloat(endTime.value)<parseFloat(startTime.value)){
    endTime.value=startTime.value;
  }
  v-end.innerText=parseFloat(endTime.value).toFixed(1)+"s";
};

processBtn.onclick=()=>{
  status.innerText=`Scanning ${startTime.value}s ‚Üí ${endTime.value}s`;
  btnDownload.style.display="block";
};

btnDownload.onclick=()=>{
  const data={start:startTime.value,end:endTime.value};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="pattern.json";
  a.click();
};
</script>

</body>
</html>