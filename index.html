<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Pattern Recorder - Margin Precision</title>
    <style>
        :root {
            --primary: #00bcd4;
            --bg: #f5f6fa;
            --text: #2f3640;
            --danger: #e74c3c;
            --success: #2ecc71; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .main-container { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            max-width: 600px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        .nav-header {
            text-align: center;
            margin-top: 200px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .nav-header h2 {
            margin: 5px 0 5px 0;
            color: #2c3e50;
            font-size: 1.2rem;
        }
        .nav-header a {
            text-decoration: none;
            color: #999;
            font-size: 0.9rem;
            margin: 0 5px;
            transition: color 0.2s;
        }
        .nav-header a:hover {
            color: var(--primary);
        }
        .nav-header .active {
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1rem;
        }
        .preview-wrapper { 
            position: relative; 
            width: 100%; 
            background: #000; 
            border-radius: 8px; 
            overflow: hidden; 
            margin-bottom: 15px; 
            line-height: 0; 
            border: 2px solid #333;
        }
        #videoPlayer {
            width: 100%;
            display: block;
        }
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .control-panel {
            background: #fdfdfd;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .slider-section {
            margin-bottom: 15px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 10px;
        }
        .slider-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .slider-title {
            font-size: 0.75rem;
            font-weight: bold;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: block;
        }
        .slider-row {
            margin-bottom: 12px;
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .slider-header label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #636e72;
        }
        .val-badge {
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: monospace;
        }
        input[type=range] {
            width: 100%;
            accent-color: var(--primary);
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            --webkit-appearance: none;
            appearance: none;
            height: 80px;
            width: 80px;
            background: var(--primary);
            border-radius: 50%;
        }
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            color: white;
            transition: 0.2s;
            margin-top: 5px;
        }
        .btn-start {
            background: var(--primary);
        }
        .btn-start:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .btn-download {
            background: var(--success);
            margin-top: 15px;
            display: none;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-top: 20px;
            width: 100%;
        }
        .cell {
            aspect-ratio: 1;
            background: #ecf0f1;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #bdc3c7;
        }
        .cell.detected {
            background: white;
            border: 2px solid var(--danger);
            color: var(--danger);
        }
        #status {
            text-align: center;
            font-size: 0.9rem;
            margin: 10px 0;
            color: #7f8c8d;
        }
        #videoInput {
            margin-bottom: 15px;
            width: 100%;
        }
        input[type="file"]::file-selector-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="onOpenCvReady()"></script>
</head>
<body>

<div class="main-container">
    <div class="nav-header">
        <h2>
            <a href="flipimage.html">Same Image Flip</a> ||
            <span class="active">Memory Pattern Recorder V3</span> || 
            <a href="sudokusolver.html">Sudoku Solver</a>
            <a href="difimage.html">Image Different</a>
        </h2>
        <div style="font-size: 0.75rem; color: #999; margin-top:5px;">Step 1: Adjust margins until green boxes match cards</div>
    </div>

    <input type="file" id="videoInput" accept="video/*">
    
    <div class="preview-wrapper">
        <video id="videoPlayer" muted playsinline></video>
        <canvas id="overlayCanvas"></canvas>
    </div>

    <div class="control-panel">
        <div class="slider-section">
            <span class="slider-title">Pengaturan Area (Margin)</span>
            <div class="slider-row">
                <div class="slider-header"><label>TOP MARGIN (%)</label><span class="val-badge" id="v-t">23.0%</span></div>
                <input type="range" id="marginTop" min="0" max="100" step="0.1" value="23.0">
            </div>
            <div class="slider-row">
                <div class="slider-header"><label>BOTTOM MARGIN (%)</label><span class="val-badge" id="v-b">15.0%</span></div>
                <input type="range" id="marginBottom" min="0" max="100" step="0.1" value="15.0">
            </div>
            <div class="slider-row">
                <div class="slider-header"><label>SIDE MARGIN (%)</label><span class="val-badge" id="v-s">5.0%</span></div>
                <input type="range" id="marginSide" min="0" max="50" step="0.1" value="5.0">
            </div>
        </div>
        <div class="slider-section">
            <span class="slider-title">Pengaturan Waktu Video</span>
            <div class="slider-row">
                <div class="slider-header"><span>MULAI (Start)</span><span id="vStart" class="val-badge">0.0s</span></div>
                <input type="range" id="startTime" step="0.1" value="0">
            </div>
            <div class="slider-row">
                <div class="slider-header"><span>SELESAI (End)</span><span id="vEnd" class="val-badge">0.0s</span></div>
                <input type="range" id="endTime" step="0.1" value="0">
            </div>
        </div>
        <button id="processBtn" class="btn btn-start" disabled>â–¶ START SCANNING</button>
        <button id="btnDownload" class="btn btn-download">ðŸ’¾ DOWNLOAD JSON</button>
    </div>
    <div class="slider-section">
        <span class="slider-title">Resolusi Layar Target (KeyMapper)</span>
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <div style="flex: 1;">
                <label style="font-size: 0.7rem; font-weight: bold; color: #666;">WIDTH</label>
                <input type="number" id="screenWidth" value="1260" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
                <label style="font-size: 0.7rem; font-weight: bold; color: #666;">HEIGHT</label>
                <input type="number" id="screenHeight" value="2800" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        <p style="font-size: 0.65rem; color: #999; margin-top: 5px;">*JSON akan dikonversi otomatis dari basis 1260x2800 ke resolusi ini.</p>
    </div>
    <div class="slider-section">
        <span class="slider-title">Custom Tap Coordinates (X, Y per baris)</span>
        <textarea id="customCoords" rows="8" style="width: 100%; font-family: monospace; font-size: 0.75rem; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="170,845
    480,845
    ..."></textarea>
        <p style="font-size: 0.65rem; color: #e74c3c; margin-top: 5px;">*Masukkan 20 baris koordinat sesuai urutan grid (Kiri ke Kanan, Atas ke Bawah).</p>
    </div>

    <div id="status">Waiting for OpenCV...</div>
    <div id="grid" class="results-grid"></div>
</div>

<canvas id="procCanvas" style="display:none;"></canvas>
<script>
let cvReady = false;
let zones = [];
let currentStep = 1;
const ROWS = 5;
const COLS = 4;

// Initialize Grid UI (20 Cells for 4x5)
const gridEl = document.getElementById('grid');
gridEl.innerHTML = '';
for (let i = 0; i < 20; i++) {
  let d = document.createElement('div');
  d.className = 'cell';
  d.id = `c-${i}`;
  d.innerText = i + 1;
  gridEl.appendChild(d);
}

const videoPlayer = document.getElementById('videoPlayer');
const overlayCanvas = document.getElementById('overlayCanvas');
const overlayCtx = overlayCanvas.getContext('2d');
const procCanvas = document.getElementById('procCanvas');
const procCtx = procCanvas.getContext('2d');
const statusEl = document.getElementById('status');
const sTop = document.getElementById('marginTop');
const sBot = document.getElementById('marginBottom');
const sSide = document.getElementById('marginSide');
const sStart = document.getElementById('startTime');
const sEnd = document.getElementById('endTime');

// Your fixed coordinates as center points (kept as metadata)
const FIXED_CENTERS = [
  [170, 845], [480, 845], [790, 845], [1100, 845],
  [170, 1145], [480, 1145], [790, 1145], [1100, 1145],
  [170, 1445], [480, 1445], [790, 1445], [1100, 1445],
  [170, 1745], [480, 1745], [790, 1745], [1100, 1745],
  [170, 2045], [480, 2045], [790, 2045], [1100, 2045]
];
const DEFAULT_COORDS_TEXT = `170,845
480,845
790,845
1100,845
170,1145
480,1145
790,1145
1100,1145
170,1445
480,1445
790,1445
1100,1445
170,1745
480,1745
790,1745
1100,1745
170,2045
480,2045
790,2045
1100,2045`;

function getCoordsFromInput() {
    const text = document.getElementById('customCoords').value.trim();
    if (!text) return [];
    return text.split('\n').map(line => {
        const parts = line.split(',');
        return [parseInt(parts[0]) || 0, parseInt(parts[1]) || 0];
    });
}

// --- LOCAL STORAGE & INIT ---
window.addEventListener('load', () => {
  loadSliderSettings();
});

function onOpenCvReady() {
  cvReady = true;
  statusEl.innerText = "Ready. Select video.";
}

function saveSliderSettings() {
    const settings = {
        top: document.getElementById('marginTop').value,
        bottom: document.getElementById('marginBottom').value,
        side: document.getElementById('marginSide').value,
        resW: document.getElementById('screenWidth').value,
        resH: document.getElementById('screenHeight').value,
        coords: document.getElementById('customCoords').value
    };
    localStorage.setItem('patternRecorderMargins', JSON.stringify(settings));
}

function loadSliderSettings() {
    const saved = localStorage.getItem('patternRecorderMargins');
    if (saved) {
        const settings = JSON.parse(saved);
        if (settings.top) document.getElementById('marginTop').value = settings.top;
        if (settings.bottom) document.getElementById('marginBottom').value = settings.bottom;
        if (settings.side) document.getElementById('marginSide').value = settings.side;
        if (settings.resW) document.getElementById('screenWidth').value = settings.resW;
        if (settings.resH) document.getElementById('screenHeight').value = settings.resH;
        
        // Load Koordinat, jika tidak ada pakai default
        document.getElementById('customCoords').value = settings.coords || DEFAULT_COORDS_TEXT;
    } else {
        document.getElementById('customCoords').value = DEFAULT_COORDS_TEXT;
    }
    // Update label persen
    document.getElementById('v-t').innerText = document.getElementById('marginTop').value + "%";
    document.getElementById('v-b').innerText = document.getElementById('marginBottom').value + "%";
    document.getElementById('v-s').innerText = document.getElementById('marginSide').value + "%";
}

// Sliders listener
['marginTop', 'marginBottom', 'marginSide'].forEach(id => {
  document.getElementById(id).addEventListener('input', (e) => {
    const badgeId = id === 'marginTop' ? 'v-t' : (id === 'marginBottom' ? 'v-b' : 'v-s');
    document.getElementById(badgeId).innerText = parseFloat(e.target.value).toFixed(1) + "%";
    saveSliderSettings();
    drawOverlay();
  });
});

//Load Video
document.getElementById('videoInput').addEventListener('change', (e) => {
  if (e.target.files[0]) {
    videoPlayer.src = URL.createObjectURL(e.target.files[0]);
    videoPlayer.onloadedmetadata = () => {
        // Set canvas pixel sizes
        overlayCanvas.width = videoPlayer.videoWidth;
        overlayCanvas.height = videoPlayer.videoHeight;
        procCanvas.width = videoPlayer.videoWidth;
        procCanvas.height = videoPlayer.videoHeight;

        // Setup Slider Waktu
        sStart.max = videoPlayer.duration;
        sEnd.max = videoPlayer.duration;
        sEnd.value = videoPlayer.duration;
        document.getElementById('vEnd').innerText = videoPlayer.duration.toFixed(1) + "s";
        
        // Also set CSS size to match displayed video if needed
        overlayCanvas.style.width = videoPlayer.clientWidth + 'px';
        overlayCanvas.style.height = (videoPlayer.clientWidth * (videoPlayer.videoHeight / videoPlayer.videoWidth)) + 'px';

        drawOverlay();
        document.getElementById('processBtn').disabled = false;
        statusEl.innerText = "Video loaded. Adjust margins if needed, then click START SCANNING.";
    };
  }
});

document.getElementById('customCoords').addEventListener('input', () => {
    saveSliderSettings();
    drawOverlay();
});

//LOGIKA GRID & OVERLAY
function getCalculatedZones() {
    if (overlayCanvas.width === 0) return [];

    const w = overlayCanvas.width;
    const h = overlayCanvas.height;
    const tPct = parseFloat(document.getElementById('marginTop').value) / 100;
    const bPct = parseFloat(document.getElementById('marginBottom').value) / 100;
    const sPct = parseFloat(document.getElementById('marginSide').value) / 100;

    const startX = w * sPct;
    const endX = w * (1 - sPct);
    const startY = h * tPct;
    const endY = h * (1 - bPct);

    const cellW = (endX - startX) / 4;
    const cellH = (endY - startY) / 5;

    // Ambil koordinat custom dari textarea
    const userCoords = getCoordsFromInput();

    let calculatedZones = [];
    for (let r = 0; r < 5; r++) {
        for (let c = 0; c < 4; c++) {
            const idx = (r * 4) + c;
            const zx = startX + (c * cellW);
            const zy = startY + (r * cellH);
            
            // Ambil koordinat dari array custom (jika index tidak ada, default ke 0,0)
            const fx = userCoords[idx] ? userCoords[idx][0] : 0;
            const fy = userCoords[idx] ? userCoords[idx][1] : 0;

            calculatedZones.push({
                x: Math.round(zx),
                y: Math.round(zy),
                w: Math.round(cellW),
                h: Math.round(cellH),
                cx: Math.round(zx + cellW / 2),
                cy: Math.round(zy + cellH / 2),
                fixedX: fx,
                fixedY: fy
            });
        }
    }
    return calculatedZones;
}

function drawOverlay() {
  if (overlayCanvas.width === 0) return;
  overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

  const zones = getCalculatedZones();

  overlayCtx.strokeStyle = "#00bcd4";
  overlayCtx.lineWidth = 2;

  zones.forEach((z, i) => {
    overlayCtx.strokeRect(z.x, z.y, z.w, z.h);

    overlayCtx.fillStyle = "#ff0000";
    overlayCtx.beginPath();
    overlayCtx.arc(z.cx, z.cy, 8, 0, Math.PI * 2);
    overlayCtx.fill();

    overlayCtx.fillStyle = "#ffffff";
    overlayCtx.font = "12px Arial";
    overlayCtx.fillText(`${z.fixedX},${z.fixedY}`, z.x + 5, z.y + 15);
  });
}

let currentTime = 0;
// Event Listeners Slider Waktu
sStart.addEventListener('input', () => {
    // Pastikan Start tidak melewati End
    if(parseFloat(sStart.value) > parseFloat(sEnd.value)) {
        sStart.value = sEnd.value;
    }
    
    const val = parseFloat(sStart.value);
    document.getElementById("vStart").innerText = val.toFixed(1) + "s";
    
    // Sinkronkan tampilan video agar nampak bergerak saat digeser
    videoPlayer.currentTime = val; 
});

// Slider Waktu Selesai (End)
sEnd.addEventListener('input', () => {
    // Pastikan End tidak kurang dari Start
    if(parseFloat(sEnd.value) < parseFloat(sStart.value)) {
        sEnd.value = sStart.value;
    }
    
    const val = parseFloat(sEnd.value);
    document.getElementById("vEnd").innerText = val.toFixed(1) + "s";
    
    // Sinkronkan tampilan video (opsional, agar tahu batas akhir scan)
    videoPlayer.currentTime = val;
});

//PROSES SCANNING
document.getElementById('processBtn').onclick = async () => {
    document.getElementById('processBtn').disabled = true;
    document.getElementById('btnDownload').style.display = 'none';
    statusEl.innerText = "Scanning berjalan...";
    
    // Reset Grid Visual
    currentStep = 1;
    document.querySelectorAll('.cell').forEach(c => {
        c.className = 'cell';
        const idx = parseInt(c.id.split('-')[1], 10);
        c.innerText = idx + 1;
    });

    const calcZones = getCalculatedZones();
    zones = calcZones.map((z, i) => ({
        id: i,
        outputData: `${z.fixedX},${z.fixedY}`,
        x: Math.round(z.x),
        y: Math.round(z.y),
        w: Math.round(z.w),
        h: Math.round(z.h),
        calcX: z.cx,
        calcY: z.cy,
        fixedX: z.fixedX,
        fixedY: z.fixedY,
        locked: false,
        step: 0
    }));

    // OpenCV mats
    let gray = new cv.Mat(),
    prevGray = new cv.Mat(),
    diff = new cv.Mat();

    // Ambil nilai dari slider saat tombol ditekan
    let startTimeVal = parseFloat(sStart.value); 
    const endTimeVal = parseFloat(sEnd.value);
    let currentTimeScan = startTimeVal; // Gunakan variabel lokal agar tidak bentrok

    const interval = 0.1; 
    const skipFactor = 5; 
    const roiW = 120, roiH = 120;
    const motionThreshold = 30; 
    const motionRatio = 0.08; 

    async function processFrame() {
        if (!videoPlayer.duration || isNaN(videoPlayer.duration)) {
            statusEl.innerText = "Video not ready.";
            document.getElementById('processBtn').disabled = false;
            return;
        }

        // BERHENTI jika sudah mencapai batas slider akhir atau durasi video
        if (currentTimeScan >= endTimeVal || currentTimeScan >= videoPlayer.duration) {
            statusEl.innerText = "Scanning Finished!";
            document.getElementById('processBtn').disabled = false;
            document.getElementById('btnDownload').style.display = 'block';
            gray.delete(); prevGray.delete(); diff.delete();
            return;
        }

        // UPDATE WAKTU VIDEO SESUAI PROSES SCAN
        videoPlayer.currentTime = currentTimeScan;
        await new Promise(r => { videoPlayer.onseeked = r; });
        
        procCtx.drawImage(videoPlayer, 0, 0, procCanvas.width, procCanvas.height);

        let src = cv.imread(procCanvas);
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

        if (prevGray.empty()) {
            gray.copyTo(prevGray);
            src.delete();
            currentTimeScan += interval;
            requestAnimationFrame(processFrame);
            return;
        }

        cv.absdiff(gray, prevGray, diff);
        cv.threshold(diff, diff, motionThreshold, 255, cv.THRESH_BINARY);

        let detected = [];
        zones.forEach(z => {
            if (z.locked) return;
            let rx = Math.round(z.calcX - roiW / 2);
            let ry = Math.round(z.calcY - roiH / 2);
            rx = Math.max(0, Math.min(rx, diff.cols - roiW));
            ry = Math.max(0, Math.min(ry, diff.rows - roiH));

            if (rx >= 0 && ry >= 0 && (rx + roiW) <= diff.cols && (ry + roiH) <= diff.rows) {
                let roi = diff.roi(new cv.Rect(rx, ry, roiW, roiH));
                const nonZero = cv.countNonZero(roi);
                roi.delete();
                if (nonZero > (roiW * roiH * motionRatio)) {
                    detected.push({ zone: z, nonZero });
                }
            }
        });

        if (detected.length > 0) {
            detected.sort((a, b) => b.nonZero - a.nonZero);
            let target = detected[0].zone;
            target.locked = true;
            target.step = currentStep;

            let cell = document.getElementById(`c-${target.id}`);
            cell.classList.add('detected');
            cell.innerText = currentStep;

            statusEl.innerText = `Step ${currentStep}: Detected at ${target.fixedX},${target.fixedY}`;

            currentStep++;
            currentTimeScan += (interval * skipFactor); 
        } else {
            currentTimeScan += interval;
        }

        gray.copyTo(prevGray);
        src.delete();
        requestAnimationFrame(processFrame);
    }

    processFrame();
};
document.getElementById('screenWidth').addEventListener('input', saveSliderSettings);
document.getElementById('screenHeight').addEventListener('input', saveSliderSettings);
// Download logic unchanged
document.getElementById('btnDownload').onclick = () => {
  const steps = zones.filter(z => z.locked).sort((a, b) => a.step - b.step);
  const targetW = parseFloat(document.getElementById('screenWidth').value) || 1260;
    const targetH = parseFloat(document.getElementById('screenHeight').value) || 2800;

    // Hitung Rasio (Base adalah 1260x2800)
    //const ratioX = targetW / 1260;
    //const ratioY = targetH / 2800;
    const ratioX = 1;
    const ratioY = 1;

    const actionList = steps.map(s => {
        // Kalkulasi koordinat baru berdasarkan resolusi target
        const finalX = Math.round(s.fixedX * ratioX);
        const finalY = Math.round(s.fixedY * ratioY);

        return {
            "data": `${finalX},${finalY}`, // Koordinat yang sudah dikonversi
            "extras": [
                { "data": String(s.step), "id": "extra_coordinate_description" },
                { "data": 125, "id": "extra_delay_before_next_action" }
            ],
            "flags": 0,
            "type": "TAP_COORDINATE",
            "uid": crypto.randomUUID()
        };
    });

  const keymapData = {
    "app_version": 63,
    "keymap_db_version": 13,
    "fingerprint_map_list": [
      {
        "action_list": [],
        "constraints": [],
        "constraint_mode": 1,
        "extras": [],
        "flags": 0,
        "id": 0,
        "enabled": true
      },
      {
        "action_list": [],
        "constraints": [],
        "constraint_mode": 1,
        "extras": [],
        "flags": 0,
        "id": 1,
        "enabled": true
      },
      {
        "action_list": [],
        "constraints": [],
        "constraint_mode": 1,
        "extras": [],
        "flags": 0,
        "id": 2,
        "enabled": true
      },
      {
        "action_list": [],
        "constraints": [],
        "constraint_mode": 1,
        "extras": [],
        "flags": 0,
        "id": 3,
        "enabled": true
      }
    ],
    "keymap_list": [{
      "actionList": actionList,
      "constraintList": [],
      "constraintMode": 1,
      "flags": 0,
      "id": 27,
      "isEnabled": true,
      "trigger": {
        "extras": [],
        "flags": 1,
        "keys": [{
          "clickType": 0,
          "deviceId": "io.github.sds100.keymapper.THIS_DEVICE",
          "flags": 0,
          "keyCode": 24,
          "uid": crypto.randomUUID()
        }],
        "mode": 2
      },
      "uid": "f27ac54c-b236-43d0-b34b-81aac1a8634b"
    }]
  };

  const blob = new Blob([JSON.stringify(keymapData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const timestamp = new Date().toISOString().replace(/T/, '_').replace(/\..+/, '').replace(/:/g, '');
  a.download = `Pattern_Result_${timestamp}.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
};
</script>
    
</body>
</html>
