<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Diff - with Accuracy Score</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --bg: #1a1a1a;
            --primary:  #673ab7;
            --panel-bg: #2d2d2d;
            --accent-a: #00ff00;
            --accent-b: #00ccff;
            --text: #eee;
            --score-good: #00ff00;
            --score-ok: #00ccff;
            --score-bad: #ff5722;
        }

        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; overflow-x: hidden; }

        /* Layout Utama: 2 Kolom */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* --- BAGIAN A: WORKSPACE --- */
        .workspace-container {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .workspace {
            position: relative;
            border: 2px solid #555;
            background: #000;
            overflow: auto;
            /* max-height: 80vh; Removed to allow full height scroll if needed */
             min-height: 400px; /* Ensure minimum height */
        }

        #main-img { display: block; }

        /* Selection Boxes */
        .box { position: absolute; box-sizing: border-box; cursor: move; border-width: 2px; border-style: solid; }
        #box-1 { border-color: var(--accent-a); z-index: 10; background: rgba(0, 255, 0, 0.05); }
        #box-2 { border-color: var(--accent-b); z-index: 11; background: rgba(0, 204, 255, 0.05); }
        
        /* Resizer yang lebih besar agar mudah disentuh */
        .resizer {
            width: 30px; height: 30px;
            background: var(--accent-a); opacity: 0.7;
            position: absolute; right: -15px; bottom: -15px;
            cursor: nwse-resize; border-radius: 50%;
        }
        .label-box { position: absolute; top: -22px; left: -2px; padding: 2px 6px; font-size: 10px; font-weight: bold; color: #000; border-radius: 3px 3px 0 0; white-space: nowrap;}

        /* --- SISI KANAN (B & C) --- */
        .side-panel { display: flex; flex-direction: column; gap: 20px; }

        /* BAGIAN B: NUDGE ARROWS */
        .nudge-panel { background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid #444; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 150px; margin: 10px auto; }
        .d-pad button { height: 40px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 18px; }
        .d-pad button:hover { background: #666; }

        /* BAGIAN C: PREVIEW & RESULT */
        .preview-panel { background: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid #444; flex-grow: 1; }
        canvas { background: #000; border: 1px solid #555; width: 100%; height: auto; margin-bottom: 15px; }

        /* Style untuk Skor Akurasi Baru */
        .score-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 11px; }
        #accuracy-score { font-weight: bold; font-size: 14px; color: var(--score-bad); transition: color 0.3s; }

        h4 { margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #aaa; letter-spacing: 1px; }
        a { color: var(--accent-b); text-decoration: none; margin: 0 5px; font-size: 14px; }
    </style>
</head>
<body>

    <div style="text-align: center; margin-bottom: 20px;">
        <div class="nav-header">
            <h2>
                <a href="index.html">Memory Pattern Recorder V3</a> || 
                <a href="flipimage.html">Same Image Flip</a> ||
                <a href="difimage.html" class="active">Image Different</a> || 
                <a href="sudokusolver.html">Sudoku Solver</a>
            </h2>
            <div style="font-size: 0.75rem; color: #999; margin-top:5px;">Step 1: Adjust margins until green boxes match cards</div>
        </div>
    </div>
    
    <input type="file" id="fileInput" class="action-btn" accept="image/*">
    <div class="main-layout">
        
        <div class="workspace-container">
            <h4>Workspace (A)</h4>
            <div class="workspace" id="workspace">
                <img id="main-img">
                <div id="box-1" class="box" style="display:none;">
                    <div class="label-box" style="background: var(--accent-a);">MASTER BORDER 1</div>
                    <div class="resizer" id="resizer"></div>
                </div>
                <div id="box-2" class="box" style="display:none;">
                    <div class="label-box" style="background: var(--accent-b);">NUDGE BORDER 2</div>
                </div>
            </div>
            <p style="font-size: 12px; color: #888; margin-top: 10px;">* Drag kotak hijau untuk posisi, tarik titik dipojok untuk resize.</p>
        </div>

        <div class="side-panel">
            
            <div class="nudge-panel">
                <h4>Positioning (B)</h4>
                <button class="action-btn" onclick="syncBox('Y')">Snap Y-Next (Samping Kanan)</button>
                <button class="action-btn" onclick="syncBox('X')">Snap X-Next (Bawah)</button>
                
                <div style="texts-align: center; margin-top: 15px;">
                    <span style="font-size: 12px;">Micro Nudge Border 2:</span>
                    <div class="d-pad">
                        <div></div><button onclick="nudge(0,-1)">▲</button><div></div>
                        <button onclick="nudge(-1,0)">◀</button>
                        <button onclick="nudge(0,1)">▼</button>
                        <button onclick="nudge(1,0)">▶</button>
                    </div>
                </div>
            </div>

            <div class="preview-panel">
                <h4>Preview & Result (C)</h4>
                
                <div class="score-container">
                    <span>Live Alignment Preview:</span>
                    <div>Diff Score: <span id="accuracy-score">0.00</span> (Lower is better)</div>
                </div>
                <canvas id="prev-canvas"></canvas>
                
                <div style="font-size: 11px; margin-bottom: 5px;">Difference Output:</div>
                <canvas id="res-canvas"></canvas>

                <button class="btn-primary" onclick="processDiff()">⚡ EXECUTE DIFF</button>
            </div>

        </div>
    </div>

    <script>
    const img = document.getElementById('main-img');
    const box1 = document.getElementById('box-1');
    const box2 = document.getElementById('box-2');
    const resizer = document.getElementById('resizer');
    const prevCanvas = document.getElementById('prev-canvas');
    const resCanvas = document.getElementById('res-canvas');
    const accuracyScoreSpan = document.getElementById('accuracy-score');

    // Canvas tersembunyi untuk menyimpan data gambar asli agar pembacaan pixel super cepat
    let sourceCanvas = document.createElement('canvas');
    let sourceCtx = null;

    let state = {
        x1: 20, y1: 20, w: 200, h: 200,
        x2: 230, y2: 20,
        isDragging: false, isResizing: false, activeBox: null,
        startX: 0, startY: 0
    };

    // --- 1. UPLOAD IMAGE & CACHE DATA ---
    document.getElementById('fileInput').onchange = (e) => {
        if(e.target.files && e.target.files[0]){
            const reader = new FileReader();
            reader.onload = (ev) => {
                img.src = ev.target.result;
                img.onload = () => {
                    // 1. Siapkan Canvas Sumber (Cache)
                    sourceCanvas.width = img.width;
                    sourceCanvas.height = img.height;
                    sourceCtx = sourceCanvas.getContext('2d', { willReadFrequently: true });
                    sourceCtx.drawImage(img, 0, 0);

                    // 2. Reset Posisi Box
                    state.w = Math.min(200, Math.floor(img.width/3));
                    state.h = Math.min(200, Math.floor(img.height/3));
                    state.x1 = 20; state.y1 = 20;
                    state.x2 = state.x1 + state.w + 20; state.y2 = 20;
                    
                    box1.style.display = 'block';
                    box2.style.display = 'block';
                    
                    updateVisuals();
                };
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    };

    // --- 2. LOGIC SNAP & NUDGE ---
    function syncBox(mode) {
        if (mode === 'Y') { 
            state.y2 = state.y1;
            state.x2 = state.x1 + state.w; // Reset ke posisi menempel di kanan
        } else if (mode === 'X') { 
            state.x2 = state.x1;
            state.y2 = state.y1 + state.h; // Reset ke posisi menempel di bawah
        }
        updateVisuals();
    }

    function nudge(dx, dy) {
        state.x2 += dx; state.y2 += dy;
        // Menggunakan requestAnimationFrame agar UI update lebih mulus
        requestAnimationFrame(updateVisuals);
    }

    // --- 3. INPUT HANDLING ---
    function getClientPos(e) {
        if (e.touches && e.touches.length > 0) {
            return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
        return { x: e.clientX, y: e.clientY };
    }

    function handleStart(e) {
        const target = e.target;
        if (target === resizer || target === box1 || target === box2) {
            if(e.type === 'touchstart') e.preventDefault(); 
            const pos = getClientPos(e);
            state.startX = pos.x;
            state.startY = pos.y;

            if (target === resizer) {
                state.isResizing = true;
            } else {
                state.isDragging = true;
                state.activeBox = target;
            }
        }
    }

    function handleMove(e) {
        if (!state.isDragging && !state.isResizing) return;
        if(e.type === 'touchmove') e.preventDefault(); 

        const pos = getClientPos(e);
        const dx = pos.x - state.startX;
        const dy = pos.y - state.startY;

        if (state.isResizing) {
            state.w = Math.max(20, state.w + dx);
            state.h = Math.max(20, state.h + dy);
        } else if (state.isDragging) {
            if (state.activeBox === box1) {
                state.x1 += dx; state.y1 += dy;
            } else {
                state.x2 += dx; state.y2 += dy;
            }
        }
        state.startX = pos.x;
        state.startY = pos.y;
        
        requestAnimationFrame(updateVisuals);
    }

    function handleEnd() {
        state.isDragging = false;
        state.isResizing = false;
        state.activeBox = null;
    }

    // Event Listeners
    window.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);
    window.addEventListener('touchstart', handleStart, { passive: false });
    window.addEventListener('touchmove', handleMove, { passive: false });
    window.addEventListener('touchend', handleEnd);


    // --- 4. RENDER LOGIC (OPTIMIZED) ---
    function updateVisuals() {
        // Update DOM
        box1.style.width = state.w + 'px'; 
        box1.style.height = state.h + 'px';
        box1.style.left = state.x1 + 'px'; 
        box1.style.top = state.y1 + 'px';

        box2.style.width = state.w + 'px'; 
        box2.style.height = state.h + 'px';
        box2.style.left = state.x2 + 'px'; 
        box2.style.top = state.y2 + 'px';

        drawPreview();
    }

    function drawPreview() {
        if (!img.src || !sourceCtx) return;

        // Pembulatan koordinat agar pixel perfect dan valid
        const rx1 = Math.round(state.x1);
        const ry1 = Math.round(state.y1);
        const rx2 = Math.round(state.x2);
        const ry2 = Math.round(state.y2);
        const rw = Math.round(state.w);
        const rh = Math.round(state.h);

        // A. Render Visual Overlay (Canvas Kecil)
        prevCanvas.width = rw; 
        prevCanvas.height = rh;
        const ctx = prevCanvas.getContext('2d');
        
        // Ambil data langsung dari Cache (Sangat Cepat)
        // Gunakan clamp agar tidak error jika keluar batas gambar
        try {
            // Draw Box 1
            ctx.globalAlpha = 1.0;
            ctx.drawImage(sourceCanvas, rx1, ry1, rw, rh, 0, 0, rw, rh);
            
            // Draw Box 2 (Ghosting)
            ctx.globalAlpha = 0.5;
            ctx.drawImage(sourceCanvas, rx2, ry2, rw, rh, 0, 0, rw, rh);
        
            // B. Hitung Skor (Langsung dari sourceCtx)
            const d1 = sourceCtx.getImageData(clamp(rx1, img.width), clamp(ry1, img.height), rw, rh).data;
            const d2 = sourceCtx.getImageData(clamp(rx2, img.width), clamp(ry2, img.height), rw, rh).data;

            let totalDiff = 0;
            // Sampling optimasi: hitung setiap pixel ke-4 untuk performa super tinggi jika area besar
            // Tapi untuk presisi kita hitung semua (loop step 4 untuk RGBA)
            for (let i = 0; i < d1.length; i += 4) {
                totalDiff += Math.abs(d1[i] - d2[i]) +      // R
                             Math.abs(d1[i+1] - d2[i+1]) +  // G
                             Math.abs(d1[i+2] - d2[i+2]);   // B
            }

            const numPixels = rw * rh;
            const score = numPixels > 0 ? totalDiff / (numPixels * 3) : 999;
            
            // Update Teks
            accuracyScoreSpan.innerText = score.toFixed(3); // 3 digit desimal
            
            // Update Warna
            if (score < 1.0) accuracyScoreSpan.style.color = "var(--score-good)";
            else if (score < 10.0) accuracyScoreSpan.style.color = "var(--score-ok)";
            else accuracyScoreSpan.style.color = "var(--score-bad)";

        } catch (e) {
            accuracyScoreSpan.innerText = "Out of Bounds";
            accuracyScoreSpan.style.color = "red";
        }
    }

    // Helper untuk mencegah error getImageData di luar batas
    function clamp(val, max) {
        if (val < 0) return 0;
        if (val >= max) return max - 1;
        return val;
    }

    function processDiff() {
        if (!sourceCtx) return;

        // Gunakan ukuran integer
        const w = Math.round(state.w);
        const h = Math.round(state.h);

        resCanvas.width = w; 
        resCanvas.height = h;
        const ctx = resCanvas.getContext('2d');
        
        const d1 = sourceCtx.getImageData(Math.round(state.x1), Math.round(state.y1), w, h).data;
        const d2 = sourceCtx.getImageData(Math.round(state.x2), Math.round(state.y2), w, h).data;
        const out = ctx.createImageData(w, h);

        for (let i = 0; i < d1.length; i += 4) {
            const diff = Math.abs(d1[i]-d2[i]) + Math.abs(d1[i+1]-d2[i+1]) + Math.abs(d1[i+2]-d2[i+2]);
            if (diff > 45) {
                out.data[i]=255; out.data[i+1]=0; out.data[i+2]=0; out.data[i+3]=255;
            } else {
                out.data[i]=d1[i]; out.data[i+1]=d1[i+1]; out.data[i+2]=d1[i+2]; out.data[i+3]=255;
            }
        }
        ctx.putImageData(out, 0, 0);
    }
</script>

</body>
</html>