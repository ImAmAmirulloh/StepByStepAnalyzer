<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Memory Solver + Debug View</title>
    <script async src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; }
        body { font-family: system-ui; background: var(--bg); color: white; text-align: center; padding: 20px; }
        
        /* Main Result Grid */
        #grid-container { 
            display: grid; grid-template-columns: repeat(4, 75px); 
            gap: 10px; justify-content: center; margin: 20px auto;
            padding: 20px; background: var(--card); border-radius: 12px; width: fit-content;
        }
        .cell {
            width: 75px; height: 75px; display: flex; align-items: center;
            justify-content: center; font-size: 28px; font-weight: 800;
            border-radius: 8px; background: #334155; border: 2px solid transparent;
        }

        /* Debug Section */
        #debug-section { margin-top: 40px; border-top: 1px solid #334155; padding-top: 20px; }
        .debug-canvas-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); 
            gap: 5px; margin-top: 10px; justify-items: center;
        }
        canvas { border: 1px solid var(--accent); max-width: 100%; height: auto; }
        .debug-label { font-size: 10px; color: var(--accent); }
    </style>
</head>
<body>

    <h1>Memory Solver</h1>
    <input type="file" id="fileInput" accept="image/*">

    <div id="grid-container"></div>

    <div id="debug-section">
        <h3>Debug: Image Slices</h3>
        <p>This shows exactly what the AI is comparing:</p>
        <div id="debug-output" class="debug-canvas-grid"></div>
    </div>

    <script>
        const colors = ['#ef4444', '#22c55e', '#3b82f6', '#eab308', '#a855f7', '#ec4899', '#06b6d4', '#f97316', '#10b981', '#6366f1', '#f43f5e', '#8b5cf6', '#d946ef', '#14b8a6'];

        // Initialize empty result grid
        const grid = document.getElementById('grid-container');
        for(let i=0; i<28; i++) {
            let div = document.createElement('div');
            div.className = 'cell';
            div.id = `res-${i}`;
            div.innerText = '?';
            grid.appendChild(div);
        }

        document.getElementById('fileInput').onchange = (e) => {
            const img = new Image();
            img.onload = () => {
                let src = cv.imread(img);
                process(src);
            };
            img.src = URL.createObjectURL(e.target.files[0]);
        };

        function process(src) {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.innerHTML = ""; // Clear old debug
            
            // 1. Precise Crop based on your image layout
            // Adjusted to remove the "Ranking stage" and "Forfeit" areas
            let x = src.cols * 0.1;
            let y = src.rows * 0.12;
            let w = src.cols * 0.8;
            let h = src.rows * 0.76;
            let board = src.roi(new cv.Rect(x, y, w, h));

            let cellW = board.cols / 4;
            let cellH = board.rows / 7;
            let cells = [];

            for (let i = 0; i < 28; i++) {
                let row = Math.floor(i / 4);
                let col = i % 4;
                let rect = new cv.Rect(col * cellW, row * cellH, cellW, cellH);
                let cellMat = board.roi(rect);
                cells.push(cellMat);

                // --- SHOW DEBUG IMAGE ---
                let container = document.createElement('div');
                let canvas = document.createElement('canvas');
                let label = document.createElement('div');
                label.className = 'debug-label';
                label.innerText = `ID: ${i}`;
                cv.imshow(canvas, cellMat);
                container.appendChild(canvas);
                container.appendChild(label);
                debugOutput.appendChild(container);
            }

            findPairs(cells);
        }

        function findPairs(cells) {
            let matched = new Array(28).fill(false);
            let pairCount = 0;

            for (let i = 0; i < 28; i++) {
                if (matched[i]) continue;
                for (let j = i + 1; j < 28; j++) {
                    if (matched[j]) continue;

                    if (compare(cells[i], cells[j])) {
                        pairCount++;
                        mark(i, j, pairCount);
                        matched[i] = matched[j] = true;
                        break;
                    }
                }
            }
        }

        function compare(m1, m2) {
            let diff = new cv.Mat();
            cv.absdiff(m1, m2, diff);
            cv.cvtColor(diff, diff, cv.COLOR_RGBA2GRAY);
            let score = cv.mean(diff)[0];
            diff.delete();
            return score < 30; // Threshold: smaller is stricter
        }

        function mark(idx1, idx2, pairId) {
            [idx1, idx2].forEach(id => {
                let el = document.getElementById(`res-${id}`);
                el.innerText = pairId;
                el.style.backgroundColor = colors[(pairId - 1) % colors.length];
                el.style.borderColor = 'white';
            });
        }
    </script>
</body>
</html>
